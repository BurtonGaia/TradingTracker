<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Boursier</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 8px;
      font-size: 16px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    .alert-low {
      background-color: #ffcccc;
    }
    .alert-high {
      background-color: #ccffcc;
    }
    .error {
      color: red;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Dashboard Boursier</h1>
  <div class="input-container">
    <input id="symbol" placeholder="Symbole (ex. AAPL)" required>
    <input id="threshold1" type="number" step="0.01" placeholder="Seuil 1 (bas)" required>
    <input id="threshold2" type="number" step="0.01" placeholder="Seuil 2 (haut)" required>
    <button onclick="addStock()">Ajouter</button>
  </div>
  <div id="error" class="error"></div>
  <table>
    <thead>
      <tr>
        <th>Symbole</th>
        <th>Prix Actuel</th>
        <th>Seuil 1 (bas)</th>
        <th>Seuil 2 (haut)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="stockTable"></tbody>
  </table>

  <script>
    // Remplacez par votre clé API Alpha Vantage
    const API_KEY = 'KP8PGQNTCCZSGQX5'; // Obtenez-la sur alphavantage.co
    let stocks = loadStocks();

    // Charger les actions depuis localStorage
    function loadStocks() {
      return JSON.parse(localStorage.getItem('stocks')) || [];
    }

    // Sauvegarder les actions dans localStorage
    function saveStocks() {
      localStorage.setItem('stocks', JSON.stringify(stocks));
    }

    // Récupérer le prix d'une action via Alpha Vantage
    async function getStockPrice(symbol) {
      try {
        const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`);
        const data = await response.json();
        if (data['Global Quote'] && data['Global Quote']['05. price']) {
          return parseFloat(data['Global Quote']['05. price']).toFixed(2);
        } else {
          throw new Error('Symbole invalide ou limite API atteinte');
        }
      } catch (error) {
        showError(`Erreur pour ${symbol}: ${error.message}`);
        return null;
      }
    }

    // Afficher une erreur temporaire
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      setTimeout(() => errorDiv.textContent = '', 5000);
    }

    // Ajouter une action
    function addStock() {
      const symbol = document.getElementById('symbol').value.toUpperCase();
      const threshold1 = parseFloat(document.getElementById('threshold1').value);
      const threshold2 = parseFloat(document.getElementById('threshold2').value);

      if (!symbol || isNaN(threshold1) || isNaN(threshold2)) {
        showError('Veuillez remplir tous les champs correctement.');
        return;
      }

      if (stocks.some(stock => stock.symbol === symbol)) {
        showError('Ce symbole est déjà suivi.');
        return;
      }

      stocks.push({ symbol, threshold1, threshold2, price: 0 });
      saveStocks();
      document.getElementById('symbol').value = '';
      document.getElementById('threshold1').value = '';
      document.getElementById('threshold2').value = '';
      updateTable();
    }

    // Supprimer une action
    function removeStock(symbol) {
      stocks = stocks.filter(stock => stock.symbol !== symbol);
      saveStocks();
      updateTable();
    }

    // Mettre à jour le tableau
    async function updateTable() {
      const tbody = document.getElementById('stockTable');
      tbody.innerHTML = '';

      for (let stock of stocks) {
        const price = await getStockPrice(stock.symbol);
        if (price !== null) {
          stock.price = price;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${stock.symbol}</td>
          <td>${stock.price || 'N/A'}</td>
          <td>${stock.threshold1}</td>
          <td>${stock.threshold2}</td>
          <td><button onclick="removeStock('${stock.symbol}')">Supprimer</button></td>
        `;

        if (stock.price && parseFloat(stock.price) <= stock.threshold1) {
          row.classList.add('alert-low');
        } else if (stock.price && parseFloat(stock.price) >= stock.threshold2) {
          row.classList.add('alert-high');
        }

        tbody.appendChild(row);
      }
    }

    // Mettre à jour toutes les 60 secondes (limite API en tête)
    setInterval(updateTable, 60000);
    updateTable(); // Chargement initial
  </script>
</body>
</html>
